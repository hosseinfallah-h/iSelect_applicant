<!DOCTYPE html>
<html lang="fa" dir="rtl">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>I-SELECT – سامانه هوشمند ثبت اطلاعات متقاضیان</title>

    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css" />
    <script src="https://cdn.jsdelivr.net/npm/particles.js"></script>

    <!-- Three.js برای آواتار سه‌بعدی -->
    <script src="https://unpkg.com/three@0.161.0/build/three.min.js"></script>
    <script src="https://unpkg.com/three@0.161.0/examples/js/loaders/GLTFLoader.js"></script>

    <!-- MediaPipe برای تشخیص چهره -->
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/control_utils/control_utils.js"
        crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/drawing_utils/drawing_utils.js"
        crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/face_mesh/face_mesh.js" crossorigin="anonymous"></script>

    <link href="https://fonts.googleapis.com/css2?family=Vazirmatn:wght@300;400;500;600;700&display=swap"
        rel="stylesheet" />

    <style>
        :root {
            --primary: #ec4899;
            --secondary: #8b5cf6;
            --accent: #3b82f6;
            --dark: #0a0f2d;
            --darker: #050814;
        }

        body {
            font-family: 'Vazirmatn', sans-serif;
            background: radial-gradient(circle at top, var(--dark), var(--darker));
            color: #fff;
            min-height: 100vh;
            overflow-x: hidden;
        }

        #particles-js {
            position: fixed;
            inset: 0;
            z-index: -1;
            background: radial-gradient(circle at top, var(--dark), var(--darker));
        }

        .glass {
            backdrop-filter: blur(25px) saturate(180%);
            background: rgba(255, 255, 255, .08);
            border: 1px solid rgba(255, 255, 255, .15);
            border-radius: 1.5rem;
            box-shadow: 0 15px 40px rgba(0, 0, 0, .6);
        }

        .glass-light {
            backdrop-filter: blur(15px) saturate(160%);
            background: rgba(255, 255, 255, .05);
            border: 1px solid rgba(255, 255, 255, .1);
            border-radius: 1rem;
        }

        .btn-grad {
            background: linear-gradient(90deg, var(--primary), var(--secondary), var(--accent));
            transition: all 0.3s ease;
        }

        .btn-grad:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(236, 72, 153, 0.4);
        }

        .voice-area {
            resize: none;
            overflow-y: auto;
            min-height: 3.25rem;
            max-height: 40vh;
            line-height: 1.8;
            white-space: pre-wrap;
            word-break: break-word;
            -webkit-overflow-scrolling: touch;
            overscroll-behavior: contain;
            box-shadow: inset 0 1px 0 rgba(255, 255, 255, .06);
            transition: all 0.3s ease;
        }

        .voice-area:focus {
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(236, 72, 153, 0.2);
        }

        .voice-area::-webkit-scrollbar {
            width: 8px;
        }

        .voice-area::-webkit-scrollbar-thumb {
            background: rgba(255, 255, 255, .18);
            border-radius: 999px;
        }

        .voice-area::-webkit-scrollbar-thumb:hover {
            background: rgba(255, 255, 255, .28);
        }

        .hint {
            font-size: .8rem;
            color: #cbd5e1;
        }

        .progress-bar {
            height: 8px;
            background: rgba(255, 255, 255, .1);
            border-radius: 4px;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--primary), var(--secondary));
            transition: width 0.5s ease;
            border-radius: 4px;
        }

        .conversation-bubble {
            max-width: 85%;
            padding: 12px 16px;
            border-radius: 18px;
            margin: 8px 0;
            animation: fadeInUp 0.3s ease;
            line-height: 1.6;
        }

        .user-bubble {
            background: linear-gradient(135deg, rgba(59, 130, 246, 0.3), rgba(37, 99, 235, 0.4));
            border: 1px solid rgba(59, 130, 246, 0.5);
            margin-left: auto;
            margin-right: 0;
        }

        .ai-bubble {
            background: linear-gradient(135deg, rgba(236, 72, 153, 0.3), rgba(219, 39, 119, 0.4));
            border: 1px solid rgba(236, 72, 153, 0.5);
            margin-right: auto;
            margin-left: 0;
        }

        .pulse-recording {
            animation: pulse 1.5s infinite;
        }

        @keyframes pulse {
            0% {
                transform: scale(1);
                box-shadow: 0 0 0 0 rgba(236, 72, 153, 0.7);
            }

            70% {
                transform: scale(1.05);
                box-shadow: 0 0 0 10px rgba(236, 72, 153, 0);
            }

            100% {
                transform: scale(1);
                box-shadow: 0 0 0 0 rgba(236, 72, 153, 0);
            }
        }

        .file-upload-area {
            border: 2px dashed rgba(255, 255, 255, 0.3);
            transition: all 0.3s ease;
            cursor: pointer;
        }

        .file-upload-area:hover,
        .file-upload-area.dragover {
            border-color: var(--primary);
            background: rgba(236, 72, 153, 0.1);
            transform: translateY(-2px);
        }

        .form-input {
            transition: all 0.3s ease;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .form-input:focus {
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(236, 72, 153, 0.2);
            background: rgba(255, 255, 255, 0.08);
        }

        .feature-card {
            transition: all 0.3s ease;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .feature-card:hover {
            transform: translateY(-5px);
            border-color: var(--primary);
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.3);
        }

        .tab-button {
            transition: all 0.3s ease;
            border-bottom: 2px solid transparent;
        }

        .tab-button.active {
            border-bottom-color: var(--primary);
            color: var(--primary);
        }

        .fade-in {
            animation: fadeIn 0.5s ease;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .typing-indicator {
            display: inline-block;
            position: relative;
        }

        .typing-indicator span {
            display: inline-block;
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.7);
            margin: 0 2px;
            animation: typing 1.4s infinite ease-in-out;
        }

        .typing-indicator span:nth-child(1) {
            animation-delay: -0.32s;
        }

        .typing-indicator span:nth-child(2) {
            animation-delay: -0.16s;
        }

        @keyframes typing {

            0%,
            80%,
            100% {
                transform: scale(0.8);
                opacity: 0.5;
            }

            40% {
                transform: scale(1);
                opacity: 1;
            }
        }

        .success-checkmark {
            width: 40px;
            height: 40px;
            margin: 0 auto;
            border-radius: 50%;
            display: block;
            stroke-width: 2;
            stroke: #4bb71b;
            stroke-miterlimit: 10;
            box-shadow: inset 0px 0px 0px #4bb71b;
            animation: fill .4s ease-in-out .4s forwards, scale .3s ease-in-out .9s both;
        }

        .checkmark__circle {
            stroke-dasharray: 166;
            stroke-dashoffset: 166;
            stroke-width: 2;
            stroke-miterlimit: 10;
            stroke: #4bb71b;
            fill: none;
            animation: stroke 0.6s cubic-bezier(0.65, 0, 0.45, 1) forwards;
        }

        .checkmark__check {
            transform-origin: 50% 50%;
            stroke-dasharray: 48;
            stroke-dashoffset: 48;
            animation: stroke 0.3s cubic-bezier(0.65, 0, 0.45, 1) 0.8s forwards;
        }

        @keyframes stroke {
            100% {
                stroke-dashoffset: 0;
            }
        }

        @keyframes scale {

            0%,
            100% {
                transform: none;
            }

            50% {
                transform: scale3d(1.1, 1.1, 1);
            }
        }

        @keyframes fill {
            100% {
                box-shadow: inset 0px 0px 0px 30px #4bb71b;
            }
        }

        /* استایل‌های جدید برای مودال مصاحبه */
        .interview-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(5, 8, 20, 0.95);
            z-index: 1000;
            display: none;
            overflow-y: auto;
        }

        .interview-content {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 2rem;
            height: 100%;
            padding: 2rem;
        }

        .interview-chat {
            display: flex;
            flex-direction: column;
            height: 100%;
        }

        .interview-widgets {
            display: flex;
            flex-direction: column;
            gap: 1.5rem;
        }

        .skill-card {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 1rem;
            padding: 1rem;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .skill-card.invalidated {
            border-color: #ef4444;
            background: rgba(239, 68, 68, 0.1);
        }

        .avatar-container {
            position: relative;
            width: 200px;
            height: 200px;
            margin: 0 auto;
        }

        .face-overlay-container {
            position: relative;
            width: 100%;
            max-width: 400px;
            margin: 0 auto;
        }

        .warning-badge {
            background: rgba(239, 68, 68, 0.2);
            border: 1px solid rgba(239, 68, 68, 0.5);
            color: #fca5a5;
            padding: 0.25rem 0.5rem;
            border-radius: 0.5rem;
            font-size: 0.75rem;
        }

        .status-valid {
            color: #4ade80;
        }

        .status-suspicious {
            color: #fbbf24;
        }

        .status-invalid {
            color: #ef4444;
        }

        /* استایل‌های جدید برای چت مصاحبه */
        .interview-chat-container {
            flex: 1;
            display: flex;
            flex-direction: column;
            min-height: 0;
        }

        .interview-chat-messages {
            flex: 1;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            justify-content: flex-end;
            min-height: 0;
        }

        .interview-chat-content {
            max-height: 100%;
            overflow-y: auto;
            padding: 1rem;
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }

        .interview-chat-bubble {
            max-width: 90%;
            padding: 0.75rem 1rem;
            border-radius: 1rem;
            animation: fadeInUp 0.3s ease;
            line-height: 1.5;
            word-wrap: break-word;
        }

        .interview-ai-bubble {
            background: linear-gradient(135deg, rgba(236, 72, 153, 0.2), rgba(219, 39, 119, 0.3));
            border: 1px solid rgba(236, 72, 153, 0.3);
            align-self: flex-start;
            margin-right: 0;
        }

        .interview-user-bubble {
            background: linear-gradient(135deg, rgba(59, 130, 246, 0.2), rgba(37, 99, 235, 0.3));
            border: 1px solid rgba(59, 130, 246, 0.3);
            align-self: flex-end;
            margin-left: 0;
        }

        .streaming-text {
            display: inline;
        }

        .streaming-cursor {
            display: inline;
            animation: blink 1s infinite;
        }

        @keyframes blink {

            0%,
            50% {
                opacity: 1;
            }

            51%,
            100% {
                opacity: 0;
            }
        }

        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @media (max-width: 1024px) {
            .interview-content {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>

<body class="flex items-start justify-center p-4 min-h-screen">
    <div id="particles-js"></div>

    <div class="w-full max-w-6xl space-y-6">
        <!-- Header Section -->
        <header class="glass px-6 py-4 flex items-center justify-between animate__animated animate__fadeInDown">
            <div class="flex items-center space-x-4 space-x-reverse">
                <div class="bg-gradient-to-r from-pink-500 to-purple-600 p-3 rounded-2xl">
                    <i class="fas fa-user-tie text-white text-xl"></i>
                </div>
                <div>
                    <h1 class="text-xl font-bold text-white">I-SELECT</h1>
                    <p class="text-sm text-white/70">سامانه هوشمند ثبت اطلاعات متقاضیان</p>
                </div>
            </div>

            <div class="flex items-center space-x-3 space-x-reverse">
                <div class="hidden md:block text-sm text-white/70 text-left">
                    <div>فایل خروجی: <code
                            class="text-pink-300 bg-pink-900/30 px-2 py-1 rounded">{{ excel_rel_path }}</code></div>
                </div>
                <a href="http://127.0.0.1:5000/" target="_blank" rel="noopener"
                    class="btn-grad text-white px-5 py-2.5 rounded-full font-semibold text-sm flex items-center space-x-2 space-x-reverse">
                    <i class="fas fa-chart-line"></i>
                    <span>داشبورد ادمین</span>
                </a>
            </div>
        </header>

        <!-- Main Content -->
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
            <!-- Left Sidebar - Features -->
            <div class="lg:col-span-1 space-y-6">
                <!-- Progress Tracker -->
                <div class="glass p-5">
                    <div class="flex justify-between items-center mb-3">
                        <h3 class="font-semibold text-white flex items-center space-x-2 space-x-reverse">
                            <i class="fas fa-tasks text-pink-400"></i>
                            <span>پیشرفت پر کردن فرم</span>
                        </h3>
                        <span id="progressPercent" class="text-lg font-bold text-pink-300">0%</span>
                    </div>
                    <div class="progress-bar">
                        <div id="progressFill" class="progress-fill" style="width: 0%"></div>
                    </div>
                    <div class="mt-3 grid grid-cols-2 gap-2 text-xs text-white/70">
                        <div class="flex items-center space-x-1 space-x-reverse">
                            <div class="w-2 h-2 rounded-full bg-green-500"></div>
                            <span>تکمیل شده</span>
                        </div>
                        <div class="flex items-center space-x-1 space-x-reverse">
                            <div class="w-2 h-2 rounded-full bg-pink-500"></div>
                            <span>در انتظار</span>
                        </div>
                    </div>
                </div>

                <!-- Features Cards -->
                <div class="glass p-5">
                    <h3 class="font-semibold text-white mb-4 flex items-center space-x-2 space-x-reverse">
                        <i class="fas fa-star text-yellow-400"></i>
                        <span>امکانات سامانه</span>
                    </h3>
                    <div class="space-y-3">
                        <div class="feature-card bg-white/5 p-3 rounded-xl">
                            <div class="flex items-center space-x-2 space-x-reverse">
                                <i class="fas fa-microphone text-pink-400"></i>
                                <span class="font-medium">تشخیص گفتار هوشمند</span>
                            </div>
                            <p class="text-xs text-white/60 mt-1">صحبت کنید، سیستم به طور خودکار متن را تشخیص می‌دهد</p>
                        </div>
                        <div class="feature-card bg-white/5 p-3 rounded-xl">
                            <div class="flex items-center space-x-2 space-x-reverse">
                                <i class="fas fa-comments text-blue-400"></i>
                                <span class="font-medium">گفتگوی تعاملی</span>
                            </div>
                            <p class="text-xs text-white/60 mt-1">سیستم سوالات لازم را به صورت مکالمه می‌پرسد</p>
                        </div>
                        <div class="feature-card bg-white/5 p-3 rounded-xl">
                            <div class="flex items-center space-x-2 space-x-reverse">
                                <i class="fas fa-file-alt text-green-400"></i>
                                <span class="font-medium">پردازش رزومه</span>
                            </div>
                            <p class="text-xs text-white/60 mt-1">آپلود رزومه و استخراج خودکار اطلاعات</p>
                        </div>
                        <div class="feature-card bg-white/5 p-3 rounded-xl">
                            <div class="flex items-center space-x-2 space-x-reverse">
                                <i class="fas fa-headset text-purple-400"></i>
                                <span class="font-medium">مصاحبه مهارتی</span>
                            </div>
                            <p class="text-xs text-white/60 mt-1">ارزیابی مهارت‌ها با آواتار سه‌بعدی و تشخیص چهره</p>
                        </div>
                    </div>
                </div>

                <!-- Quick Actions -->
                <div class="glass p-5">
                    <h3 class="font-semibold text-white mb-4">دسترسی سریع</h3>
                    <div class="grid grid-cols-2 gap-3">
                        <button id="toggleConversation"
                            class="bg-blue-500/20 hover:bg-blue-500/30 border border-blue-500/30 py-2 rounded-xl text-sm transition-all flex items-center justify-center space-x-1 space-x-reverse">
                            <i class="fas fa-comment-dots"></i>
                            <span>گفتگوی هوشمند</span>
                        </button>
                        <button id="clearAll"
                            class="bg-red-500/20 hover:bg-red-500/30 border border-red-500/30 py-2 rounded-xl text-sm transition-all flex items-center justify-center space-x-1 space-x-reverse">
                            <i class="fas fa-broom"></i>
                            <span>پاک کردن همه</span>
                        </button>
                        <button id="generateInsights"
                            class="bg-purple-500/20 hover:bg-purple-500/30 border border-purple-500/30 py-2 rounded-xl text-sm transition-all flex items-center justify-center space-x-1 space-x-reverse">
                            <i class="fas fa-brain"></i>
                            <span>تجزیه و تحلیل</span>
                        </button>
                        <button id="openInterview"
                            class="bg-green-500/20 hover:bg-green-500/30 border border-green-500/30 py-2 rounded-xl text-sm transition-all flex items-center justify-center space-x-1 space-x-reverse">
                            <i class="fas fa-headset"></i>
                            <span>مصاحبه مهارتی</span>
                        </button>
                    </div>
                </div>
            </div>

            <!-- Main Content Area -->
            <div class="lg:col-span-2 space-y-6">
                <!-- Success Message -->
                {% if success and last_record %}
                <div
                    class="glass p-4 rounded-xl bg-gradient-to-r from-green-500/20 to-emerald-500/10 border border-green-500/20 flex items-center space-x-3 space-x-reverse animate__animated animate__fadeIn">
                    <svg class="success-checkmark" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 52 52">
                        <circle class="checkmark__circle" cx="26" cy="26" r="25" fill="none" />
                        <path class="checkmark__check" fill="none" d="M14.1 27.2l7.1 7.2 16.7-16.8" />
                    </svg>
                    <div>
                        <h4 class="font-semibold text-green-300">رکورد با موفقیت ثبت شد!</h4>
                        <p class="text-sm text-green-200/80">اطلاعات شما در سیستم ذخیره گردید.</p>
                    </div>
                </div>
                {% endif %}

                <!-- Tabs Navigation -->
                <div class="glass p-1 rounded-2xl flex">
                    <button class="tab-button flex-1 py-3 text-center font-medium active" data-tab="voice">
                        <i class="fas fa-microphone mr-2"></i>
                        ورود صوتی
                    </button>
                    <button class="tab-button flex-1 py-3 text-center font-medium" data-tab="conversation">
                        <i class="fas fa-comments mr-2"></i>
                        گفتگوی هوشمند
                    </button>
                    <button class="tab-button flex-1 py-3 text-center font-medium" data-tab="upload">
                        <i class="fas fa-file-upload mr-2"></i>
                        آپلود رزومه
                    </button>
                </div>

                <!-- Voice Input Tab -->
                <div id="voice-tab" class="tab-content fade-in">
                    <div class="glass p-6">
                        <h2 class="text-xl font-bold text-white mb-4 flex items-center space-x-2 space-x-reverse">
                            <i class="fas fa-microphone text-pink-400"></i>
                            <span>ورود اطلاعات از طریق گفتار</span>
                        </h2>

                        <div class="space-y-4">
                            <div class="flex flex-col md:flex-row gap-4 items-start">
                                <button id="voiceBtn" type="button"
                                    class="btn-grad text-white px-6 py-3 rounded-xl font-semibold flex items-center justify-center space-x-2 space-x-reverse shrink-0 w-full md:w-auto">
                                    <i class="fas fa-microphone"></i>
                                    <span>شروع صحبت</span>
                                </button>
                                <div class="flex-1 w-full">
                                    <label for="voiceText" class="sr-only">متن گفتار</label>
                                    <textarea id="voiceText" rows="3" dir="auto"
                                        placeholder="مثال: «من علی رضایی ۲۸ سالمه، ۴ سال سابقه کار در زمینه برنامه‌نویسی دارم، ساکن تهران هستم. مهارت‌هایم شامل Python، SQL و Django است. به حوزه‌های هوش مصنوعی و یادگیری ماشین علاقه‌مندم.»"
                                        class="voice-area w-full rounded-xl bg-gray-900/40 text-white/90 border border-white/10 focus:border-pink-500 focus:outline-none px-4 py-3 leading-relaxed placeholder:text-white/40"></textarea>
                                    <div class="mt-2 flex items-center justify-between text-xs text-gray-300/80">
                                        <span class="hint">پس از ۳ ثانیه سکوت، گفتار به صورت خودکار پردازش می‌شود</span>
                                        <span id="charCount" class="hidden sm:inline">۰ کاراکتر</span>
                                    </div>
                                </div>
                            </div>

                            <div class="flex flex-wrap gap-2 justify-center md:justify-start">
                                <button id="fillFromVoice" type="button"
                                    class="px-5 py-2.5 rounded-xl font-semibold bg-white/10 hover:bg-white/20 border border-white/10 transition-all flex items-center space-x-2 space-x-reverse">
                                    <i class="fas fa-magic"></i>
                                    <span>پردازش و پرکردن فرم</span>
                                </button>
                                <button id="clearVoice" type="button"
                                    class="px-5 py-2.5 rounded-xl font-semibold bg-white/5 hover:bg-white/15 border border-white/10 transition-all flex items-center space-x-2 space-x-reverse">
                                    <i class="fas fa-eraser"></i>
                                    <span>پاک کردن متن</span>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Conversation Tab -->
                <div id="conversation-tab" class="tab-content hidden fade-in">
                    <div class="glass p-6">
                        <h2 class="text-xl font-bold text-white mb-4 flex items-center space-x-2 space-x-reverse">
                            <i class="fas fa-comments text-blue-400"></i>
                            <span>گفتگوی هوشمند برای تکمیل اطلاعات</span>
                        </h2>

                        <div id="conversationContainer" class="mb-4">
                            <div id="conversation"
                                class="h-64 overflow-y-auto p-4 rounded-xl bg-gray-900/40 border border-white/10 space-y-3">
                                <div class="conversation-bubble ai-bubble">
                                    <div class="font-semibold text-blue-300 mb-1">I-SELECT</div>
                                    سلام! من دستیار هوشمند I-SELECT هستم. می‌تونم کمکتون کنم اطلاعاتتون رو به صورت
                                    مکالمه کامل کنیم. لطفاً میکروفون را روشن کنید تا شروع کنیم.
                                </div>
                            </div>
                        </div>

                        <div class="flex gap-2">
                            <button id="startConversationVoice"
                                class="btn-grad text-white px-5 py-3 rounded-xl font-semibold flex items-center space-x-2 space-x-reverse w-full">
                                <i class="fas fa-microphone"></i>
                                <span>شروع گوش دادن به پاسخ</span>
                            </button>
                        </div>
                        <p class="text-xs text-gray-300/80 mt-2">پس از ۸ ثانیه سکوت، گفتگوی هوشمند پایان می‌یابد اگر
                            پاسخی دریافت نشود.</p>
                    </div>
                </div>

                <!-- Upload Tab -->
                <div id="upload-tab" class="tab-content hidden fade-in">
                    <div class="glass p-6">
                        <h2 class="text-xl font-bold text-white mb-4 flex items-center space-x-2 space-x-reverse">
                            <i class="fas fa-file-upload text-green-400"></i>
                            <span>آپلود و پردازش رزومه</span>
                        </h2>

                        <div id="fileUploadArea"
                            class="file-upload-area rounded-2xl p-8 text-center cursor-pointer transition-all mb-4">
                            <input type="file" id="resumeFile" accept=".pdf,.doc,.docx,.txt" class="hidden" />
                            <div class="space-y-4">
                                <div class="text-5xl text-white/60">
                                    <i class="fas fa-cloud-upload-alt"></i>
                                </div>
                                <p class="text-white/80 text-lg">رزومه خود را اینجا رها کنید یا برای انتخاب کلیک کنید
                                </p>
                                <p class="text-sm text-white/60">فرمت‌های مجاز: PDF, Word, Text</p>
                            </div>
                        </div>

                        <div id="fileUploadProgress" class="hidden">
                            <div class="flex justify-between text-sm mb-2">
                                <span class="text-white/80">در حال پردازش فایل...</span>
                                <span id="uploadProgressPercent" class="font-semibold text-green-400">0%</span>
                            </div>
                            <div class="progress-bar">
                                <div id="uploadProgressFill" class="progress-fill" style="width: 0%"></div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Main Form -->
                <form method="post" action="/" class="space-y-6" id="mainForm">
                    <!-- فیلدهای پنهان برای ذخیره نتایج مصاحبه -->
                    <input type="hidden" id="interview_done" name="interview_done" value="false">
                    <input type="hidden" id="interview_overall" name="Interv_OverallScore">
                    <input type="hidden" id="interview_summary" name="Interv_Summary">
                    <input type="hidden" id="interview_perskill" name="Interv_PerSkillJSON">

                    <div class="glass p-6">
                        <h2 class="text-xl font-bold text-white mb-6 flex items-center space-x-2 space-x-reverse">
                            <i class="fas fa-user-edit text-purple-400"></i>
                            <span>فرم اطلاعات فردی</span>
                        </h2>

                        <div class="grid md:grid-cols-2 gap-6">
                            <div>
                                <label
                                    class="block mb-2 text-white font-semibold flex items-center space-x-1 space-x-reverse">
                                    <i class="fas fa-user text-pink-400 text-sm"></i>
                                    <span>نام</span>
                                </label>
                                <input name="first_name" type="text" data-field="first_name"
                                    class="form-input w-full p-3 rounded-xl text-white" />
                            </div>
                            <div>
                                <label
                                    class="block mb-2 text-white font-semibold flex items-center space-x-1 space-x-reverse">
                                    <i class="fas fa-users text-pink-400 text-sm"></i>
                                    <span>نام خانوادگی</span>
                                </label>
                                <input name="last_name" type="text" data-field="last_name"
                                    class="form-input w-full p-3 rounded-xl text-white" />
                            </div>
                        </div>

                        <div class="grid md:grid-cols-3 gap-6 mt-6">
                            <div>
                                <label
                                    class="block mb-2 text-white font-semibold flex items-center space-x-1 space-x-reverse">
                                    <i class="fas fa-birthday-cake text-blue-400 text-sm"></i>
                                    <span>سن</span>
                                </label>
                                <input name="age" type="number" min="0" data-field="age"
                                    class="form-input w-full p-3 rounded-xl text-white" />
                            </div>
                            <div>
                                <label
                                    class="block mb-2 text-white font-semibold flex items-center space-x-1 space-x-reverse">
                                    <i class="fas fa-venus-mars text-blue-400 text-sm"></i>
                                    <span>جنسیت</span>
                                </label>
                                <select name="gender" data-field="gender"
                                    class="form-input w-full p-3 rounded-xl text-white">
                                    <option value=""></option>
                                    <option value="مرد">مرد</option>
                                    <option value="زن">زن</option>
                                </select>
                            </div>
                            <div>
                                <label
                                    class="block mb-2 text-white font-semibold flex items-center space-x-1 space-x-reverse">
                                    <i class="fas fa-briefcase text-blue-400 text-sm"></i>
                                    <span>سال سابقه کار</span>
                                </label>
                                <input name="experience_years" type="number" min="0" data-field="experience_years"
                                    class="form-input w-full p-3 rounded-xl text-white" />
                            </div>
                        </div>

                        <div class="grid md:grid-cols-2 gap-6 mt-6">
                            <div>
                                <label
                                    class="block mb-2 text-white font-semibold flex items-center space-x-1 space-x-reverse">
                                    <i class="fas fa-city text-green-400 text-sm"></i>
                                    <span>شهر محل سکونت</span>
                                </label>
                                <input name="city" type="text" data-field="city"
                                    class="form-input w-full p-3 rounded-xl text-white" />
                            </div>
                            <div>
                                <label
                                    class="block mb-2 text-white font-semibold flex items-center space-x-1 space-x-reverse">
                                    <i class="fas fa-shield-alt text-green-400 text-sm"></i>
                                    <span>وضعیت سربازی</span>
                                </label>
                                <select name="military_status" data-field="military_status"
                                    class="form-input w-full p-3 rounded-xl text-white">
                                    <option value=""></option>
                                    <option value="دارد">دارد</option>
                                    <option value="ندارد">ندارد</option>
                                    <option value="معاف">معاف</option>
                                    <option value="در حال خدمت">در حال خدمت</option>
                                </select>
                            </div>
                        </div>

                        <div class="mt-6">
                            <label
                                class="block mb-2 text-white font-semibold flex items-center space-x-1 space-x-reverse">
                                <i class="fas fa-tools text-yellow-400 text-sm"></i>
                                <span>مهارت های کلیدی</span>
                            </label>
                            <input name="skills" type="text" placeholder="مثلاً: Python, SQL, Django, React, Docker"
                                data-field="skills" class="form-input w-full p-3 rounded-xl text-white" />
                        </div>

                        <div class="mt-6">
                            <label
                                class="block mb-2 text-white font-semibold flex items-center space-x-1 space-x-reverse">
                                <i class="fas fa-heart text-red-400 text-sm"></i>
                                <span>علایق و زمینه‌های مورد علاقه</span>
                            </label>
                            <input name="interests" type="text"
                                placeholder="مثلاً: هوش مصنوعی، یادگیری ماشین، توسعه وب، امنیت اطلاعات"
                                data-field="interests" class="form-input w-full p-3 rounded-xl text-white" />
                        </div>
                    </div>

                    <!-- AI Insights Section -->
                    <div id="aiInsights" class="hidden space-y-4">
                        <!-- AI Recommendations -->
                        <div id="aiRecommendations"
                            class="glass p-5 rounded-xl bg-gradient-to-r from-blue-500/10 to-cyan-500/10 border border-blue-500/20">
                            <h4 class="font-semibold text-blue-300 mb-3 flex items-center space-x-2 space-x-reverse">
                                <i class="fas fa-briefcase"></i>
                                <span>پیشنهادهای شغلی متناسب با پروفایل شما</span>
                            </h4>
                            <div id="jobSuggestions" class="text-sm text-gray-200 space-y-2"></div>
                        </div>

                        <!-- AI Summary -->
                        <div id="aiSummary"
                            class="glass p-5 rounded-xl bg-gradient-to-r from-purple-500/10 to-pink-500/10 border border-purple-500/20">
                            <h4 class="font-semibold text-purple-300 mb-3 flex items-center space-x-2 space-x-reverse">
                                <i class="fas fa-file-alt"></i>
                                <span>خلاصه پروفایل حرفه‌ای</span>
                            </h4>
                            <div id="summaryText" class="text-sm text-gray-200 leading-relaxed"></div>
                        </div>
                    </div>

                    <!-- Form Actions -->
                    <div class="flex flex-col sm:flex-row gap-4 justify-center items-center">
                        <button type="submit" id="submitBtn"
                            class="btn-grad text-white px-10 py-3.5 rounded-xl font-semibold text-lg flex items-center space-x-2 space-x-reverse">
                            <i class="fas fa-save"></i>
                            <span>ثبت نهایی اطلاعات</span>
                        </button>
                        <button type="button" id="manualInsights"
                            class="px-8 py-3.5 rounded-xl font-semibold bg-purple-500/20 hover:bg-purple-500/30 border border-purple-500/30 text-white transition-all flex items-center space-x-2 space-x-reverse">
                            <i class="fas fa-brain"></i>
                            <span>تولید پیشنهادات هوشمند</span>
                        </button>
                    </div>
                </form>

                <!-- Last Record Preview -->
                {% if success and last_record %}
                <div class="glass p-5 rounded-xl border border-white/10 mt-6">
                    <h3 class="text-xl font-bold text-pink-300 mb-4 flex items-center space-x-2 space-x-reverse">
                        <i class="fas fa-history"></i>
                        <span>آخرین رکورد ثبت‌شده</span>
                    </h3>
                    <div class="grid md:grid-cols-2 gap-4 text-sm text-gray-100">
                        <div class="bg-white/5 p-3 rounded-lg"><b>نام:</b> {{ last_record.first_name }}</div>
                        <div class="bg-white/5 p-3 rounded-lg"><b>نام خانوادگی:</b> {{ last_record.last_name }}</div>
                        <div class="bg-white/5 p-3 rounded-lg"><b>سن:</b> {{ last_record.age }}</div>
                        <div class="bg-white/5 p-3 rounded-lg"><b>جنسیت:</b> {{ last_record.gender }}</div>
                        <div class="bg-white/5 p-3 rounded-lg"><b>سابقه کار (سال):</b> {{ last_record.experience_years
                            }}</div>
                        <div class="bg-white/5 p-3 rounded-lg"><b>شهر:</b> {{ last_record.city }}</div>
                        <div class="bg-white/5 p-3 rounded-lg"><b>وضعیت سربازی:</b> {{ last_record.military_status }}
                        </div>
                        <div class="md:col-span-2 bg-white/5 p-3 rounded-lg"><b>مهارت‌ها:</b> {{ last_record.skills }}
                        </div>
                        <div class="md:col-span-2 bg-white/5 p-3 rounded-lg"><b>علایق:</b> {{ last_record.interests }}
                        </div>
                    </div>
                </div>
                {% endif %}
            </div>
        </div>

        <!-- Footer -->
        <footer class="glass px-6 py-4 text-center text-white/60 text-sm">
            <p>I-SELECT &copy; 2025 - سامانه هوشمند ثبت و مدیریت اطلاعات متقاضیان</p>
        </footer>
    </div>

    <!-- مودال مصاحبه مهارتی -->
    <div id="interviewModal" class="interview-modal">
        <div class="interview-content">
            <!-- ستون چپ - رابط چت و آواتار -->
            <div class="interview-chat">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-2xl font-bold text-white">مصاحبه مهارتی</h2>
                    <button id="closeInterview" class="text-white/70 hover:text-white text-xl">
                        <i class="fas fa-times"></i>
                    </button>
                </div>

                <!-- آواتار سه‌بعدی -->
                <div class="avatar-container mb-4">
                    <canvas id="avatarCanvas"></canvas>
                </div>

                <!-- چت مصاحبه -->
                <div class="interview-chat-container">
                    <div class="interview-chat-messages">
                        <div id="intChat" class="interview-chat-content">
                            <div class="interview-chat-bubble interview-ai-bubble">
                                <div class="font-semibold text-blue-300 mb-1">دستیار مصاحبه</div>
                                <div>سلام! به بخش مصاحبه مهارتی خوش آمدید. در این بخش مهارت‌های شما ارزیابی خواهد شد.
                                    لطفاً آماده باشید.</div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- کنترل‌های مصاحبه -->
                <div class="flex gap-2 mt-4">
                    <button id="intStart"
                        class="btn-grad text-white px-4 py-2 rounded-xl font-semibold flex items-center space-x-2 space-x-reverse flex-1">
                        <i class="fas fa-microphone"></i>
                        <span>شروع ضبط</span>
                    </button>
                    <button id="intStop" disabled
                        class="bg-gray-600 text-white px-4 py-2 rounded-xl font-semibold flex items-center space-x-2 space-x-reverse flex-1">
                        <i class="fas fa-stop"></i>
                        <span>توقف</span>
                    </button>
                    <button id="intFinish" disabled
                        class="bg-green-600 text-white px-4 py-2 rounded-xl font-semibold flex items-center space-x-2 space-x-reverse flex-1">
                        <i class="fas fa-flag-checkered"></i>
                        <span>اتمام مصاحبه</span>
                    </button>
                </div>
            </div>

            <!-- ستون راست - ویجت‌ها -->
            <div class="interview-widgets">
                <!-- ناحیه تشخیص چهره -->
                <div class="face-overlay-container">
                    <video id="userCam" autoplay playsinline muted class="w-full rounded-xl"></video>
                    <canvas id="faceOverlay" class="absolute top-0 left-0 w-full h-full"></canvas>
                </div>

                <!-- وضعیت‌ها -->
                <div class="glass p-4">
                    <h3 class="font-semibold text-white mb-3">وضعیت مصاحبه</h3>
                    <div class="space-y-3">
                        <div class="flex justify-between items-center">
                            <span class="text-white/70">پیشرفت کل:</span>
                            <div class="w-24 progress-bar">
                                <div id="intProgress" class="progress-fill" style="width: 0%"></div>
                            </div>
                        </div>
                        <div class="flex justify-between items-center">
                            <span class="text-white/70">سوال:</span>
                            <span id="qCounter" class="text-white font-semibold">0/0</span>
                        </div>
                        <div class="flex justify-between items-center">
                            <span class="text-white/70">هشدارها:</span>
                            <span id="warnCounter" class="warning-badge">0</span>
                        </div>
                    </div>
                </div>

                <!-- کارت‌های مهارت -->
                <div class="glass p-4">
                    <h3 class="font-semibold text-white mb-3">مهارت‌ها</h3>
                    <div id="skillCards" class="space-y-2">
                        <!-- کارت‌های مهارت به صورت پویا اضافه خواهند شد -->
                    </div>
                </div>

                <!-- اعلان‌های لحظه‌ای -->
                <div id="intAlerts" class="space-y-2">
                    <!-- اعلان‌ها اینجا نمایش داده می‌شوند -->
                </div>
            </div>
        </div>
    </div>

    <script>
        // State management
        let conversationMode = false;
        let currentQuestion = null;
        let recognition = null;
        let isRecording = false;
        let silenceTimer;
        let conversationActive = false;
        let conversationAnswer = '';

        // State مصاحبه
        let interviewActive = false;
        let currentSkillIndex = 0;
        let currentQuestionIndex = 0;
        let warnings = {};
        let skills = [];
        let interviewQuestions = {};
        let interviewAnswers = {};
        let faceMesh = null;
        let avatarScene = null;
        let avatarMorphTarget = null;
        let gazeAwayTimer = null;
        let faceLostTimer = null;
        let currentTTS = null;
        let lipsyncInterval = null;
        let currentStreamingText = '';
        let currentStreamingIndex = 0;
        let currentUserStreamingText = '';
        let currentUserStreamingIndex = 0;

        // DOM elements
        const voiceBtn = document.getElementById("voiceBtn");
        const voiceText = document.getElementById("voiceText");
        const fillBtn = document.getElementById("fillFromVoice");
        const clearBtn = document.getElementById("clearVoice");
        const charCount = document.getElementById("charCount");
        const conversationContainer = document.getElementById("conversationContainer");
        const conversation = document.getElementById("conversation");
        const startConversationVoiceBtn = document.getElementById("startConversationVoice");
        const toggleConversationBtn = document.getElementById("toggleConversation");
        const clearAllBtn = document.getElementById("clearAll");
        const generateInsightsBtn = document.getElementById("generateInsights");
        const manualInsightsBtn = document.getElementById("manualInsights");
        const fileUploadArea = document.getElementById("fileUploadArea");
        const resumeFile = document.getElementById("resumeFile");
        const uploadProgress = document.getElementById("fileUploadProgress");
        const uploadProgressFill = document.getElementById("uploadProgressFill");
        const uploadProgressPercent = document.getElementById("uploadProgressPercent");
        const progressFill = document.getElementById("progressFill");
        const progressPercent = document.getElementById("progressPercent");
        const aiInsights = document.getElementById("aiInsights");
        const aiRecommendations = document.getElementById("aiRecommendations");
        const jobSuggestions = document.getElementById("jobSuggestions");
        const aiSummary = document.getElementById("aiSummary");
        const summaryText = document.getElementById("summaryText");
        const tabButtons = document.querySelectorAll('.tab-button');
        const tabContents = document.querySelectorAll('.tab-content');
        const submitBtn = document.getElementById("submitBtn");

        // عناصر مصاحبه
        const openInterviewBtn = document.getElementById("openInterview");
        const interviewModal = document.getElementById("interviewModal");
        const closeInterviewBtn = document.getElementById("closeInterview");
        const intChat = document.getElementById("intChat");
        const intStart = document.getElementById("intStart");
        const intStop = document.getElementById("intStop");
        const intFinish = document.getElementById("intFinish");
        const intProgress = document.getElementById("intProgress");
        const qCounter = document.getElementById("qCounter");
        const warnCounter = document.getElementById("warnCounter");
        const skillCards = document.getElementById("skillCards");
        const intAlerts = document.getElementById("intAlerts");
        const avatarCanvas = document.getElementById("avatarCanvas");
        const userCam = document.getElementById("userCam");
        const faceOverlay = document.getElementById("faceOverlay");

        // فیلدهای پنهان
        const interviewDone = document.getElementById("interview_done");
        const interviewOverall = document.getElementById("interview_overall");
        const interviewSummary = document.getElementById("interview_summary");
        const interviewPerskill = document.getElementById("interview_perskill");

        // Initialize Particles.js
        particlesJS("particles-js", {
            particles: {
                number: { value: 80, density: { enable: true, value_area: 800 } },
                color: { value: "#ec4899" },
                shape: { type: "circle" },
                opacity: { value: 0.3, random: true },
                size: { value: 3, random: true },
                line_linked: {
                    enable: true,
                    distance: 150,
                    color: "#3b82f6",
                    opacity: 0.2,
                    width: 1
                },
                move: { enable: true, speed: 2, direction: "none", random: true }
            },
            interactivity: {
                detect_on: "canvas",
                events: {
                    onhover: { enable: true, mode: "grab" },
                    onclick: { enable: true, mode: "push" }
                },
                modes: {
                    grab: { distance: 200, line_linked: { opacity: 0.5 } },
                    push: { particles_nb: 4 }
                }
            },
            retina_detect: true
        });

        // مدیریت فعال/غیرفعال بودن دکمه ثبت نهایی
        function updateSubmitButton() {
            if (interviewDone.value === "true") {
                submitBtn.disabled = false;
                submitBtn.classList.remove('bg-gray-500');
                submitBtn.classList.add('btn-grad');
            } else {
                submitBtn.disabled = true;
                submitBtn.classList.remove('btn-grad');
                submitBtn.classList.add('bg-gray-500');
            }
        }

        // Tab switching functionality
        tabButtons.forEach(button => {
            button.addEventListener('click', () => {
                const tabId = button.getAttribute('data-tab');

                // Update active tab button
                tabButtons.forEach(btn => btn.classList.remove('active'));
                button.classList.add('active');

                // Show active tab content
                tabContents.forEach(content => {
                    content.classList.add('hidden');
                    if (content.id === `${tabId}-tab`) {
                        content.classList.remove('hidden');
                    }
                });
            });
        });

        // Progress tracking
        function updateProgress() {
            const fields = document.querySelectorAll('.form-input');
            let filled = 0;
            fields.forEach(field => {
                if (field.value && field.value.toString().trim() !== '') {
                    filled++;
                }
            });
            const percent = fields.length > 0 ? Math.round((filled / fields.length) * 100) : 0;
            progressFill.style.width = `${percent}%`;
            progressPercent.textContent = `${percent}%`;
        }

        // Initialize progress tracking
        document.querySelectorAll('.form-input').forEach(field => {
            field.addEventListener('input', updateProgress);
        });
        updateProgress();
        updateSubmitButton();

        // Voice UI with real-time transcription and auto-stop
        function autoGrow(el) {
            el.style.height = '0px';
            const maxH = window.innerHeight * 0.4;
            el.style.height = Math.min(el.scrollHeight + 2, maxH) + 'px';
            el.scrollTop = el.scrollHeight;
            if (charCount) charCount.textContent = (el.value.length.toLocaleString('fa-IR')) + ' کاراکتر';
        }

        voiceText.addEventListener('input', () => autoGrow(voiceText));
        window.addEventListener('resize', () => autoGrow(voiceText), { passive: true });
        autoGrow(voiceText);

        // Enhanced Speech Recognition
        (function initSTT() {
            try {
                const SR = window.SpeechRecognition || window.webkitSpeechRecognition;
                if (!SR) {
                    voiceBtn.disabled = true;
                    startConversationVoiceBtn.disabled = true;
                    voiceBtn.innerHTML = '<i class="fas fa-microphone-slash"></i><span>مرورگر پشتیبانی نمی‌کند</span>';
                    return;
                }

                recognition = new SR();
                recognition.lang = "fa-IR";
                recognition.continuous = true;
                recognition.interimResults = true;
                recognition.maxAlternatives = 1;

                recognition.addEventListener("result", (e) => {
                    let final = '';
                    let interim = '';

                    for (let i = e.resultIndex; i < e.results.length; i++) {
                        const transcript = e.results[i][0].transcript;
                        if (e.results[i].isFinal) {
                            final += transcript;
                        } else {
                            interim += transcript;
                        }
                    }

                    // Reset silence timer when speech is detected
                    clearTimeout(silenceTimer);
                    if (interim || final) {
                        const silenceDuration = conversationActive ? 8000 : 3000;
                        silenceTimer = setTimeout(() => {
                            if (isRecording) {
                                recognition.stop();
                            }
                        }, silenceDuration);
                    }

                    if (conversationActive) {
                        conversationAnswer = final || interim;
                    } else if (interviewActive && isRecording) {
                        // استریم متن کاربر در مصاحبه
                        currentUserStreamingText = final || interim;
                        updateUserStreamingText();
                    } else {
                        voiceText.value = final || interim;
                        autoGrow(voiceText);
                    }
                });

                recognition.addEventListener("end", () => {
                    isRecording = false;
                    if (conversationActive) {
                        startConversationVoiceBtn.innerHTML = '<i class="fas fa-microphone"></i><span>شروع گوش دادن به پاسخ</span>';
                        startConversationVoiceBtn.classList.remove("pulse-recording");
                        if (conversationAnswer.trim()) {
                            addMessage(conversationAnswer, 'user');
                            processConversation(conversationAnswer);
                            conversationAnswer = '';
                        } else {
                            // No answer, end conversation
                            conversationActive = false;
                            addMessage("گفتگو به دلیل عدم پاسخ به پایان رسید.", 'ai');
                            generateAIInsights();
                        }
                    } else if (interviewActive) {
                        intStart.disabled = false;
                        intStop.disabled = true;
                        intStart.innerHTML = '<i class="fas fa-microphone"></i><span>شروع ضبط</span>';
                        intStart.classList.remove("pulse-recording");

                        // ذخیره پاسخ نهایی کاربر
                        if (currentUserStreamingText.trim()) {
                            const currentSkill = skills[currentSkillIndex];
                            if (!interviewAnswers[currentSkill]) {
                                interviewAnswers[currentSkill] = [];
                            }
                            interviewAnswers[currentSkill].push(currentUserStreamingText);

                            // پاک کردن متن استریم
                            currentUserStreamingText = '';
                            currentUserStreamingIndex = 0;

                            // رفتن به سوال بعدی
                            setTimeout(() => {
                                currentQuestionIndex++;
                                askNextQuestion();
                            }, 1000);
                        }
                    } else {
                        voiceBtn.innerHTML = '<i class="fas fa-microphone"></i><span>شروع صحبت</span>';
                        voiceBtn.classList.remove("pulse-recording");
                        if (voiceText.value.trim()) {
                            setTimeout(() => fillBtn.click(), 500);
                        }
                    }
                    clearTimeout(silenceTimer);
                });

                recognition.addEventListener("error", (e) => {
                    console.error("Speech recognition error:", e.error);
                    isRecording = false;
                    if (conversationActive) {
                        startConversationVoiceBtn.innerHTML = '<i class="fas fa-microphone"></i><span>شروع گوش دادن به پاسخ</span>';
                        startConversationVoiceBtn.classList.remove("pulse-recording");
                    } else if (interviewActive) {
                        intStart.disabled = false;
                        intStop.disabled = true;
                        intStart.innerHTML = '<i class="fas fa-microphone"></i><span>شروع ضبط</span>';
                        intStart.classList.remove("pulse-recording");
                    } else {
                        voiceBtn.innerHTML = '<i class="fas fa-microphone"></i><span>شروع صحبت</span>';
                        voiceBtn.classList.remove("pulse-recording");
                    }
                    clearTimeout(silenceTimer);

                    if (e.error === 'not-allowed') {
                        alert('دسترسی به میکروفون مجاز نیست. لطفاً تنظیمات مرورگر خود را بررسی کنید.');
                    }
                });

            } catch (e) {
                console.warn("SpeechRecognition init error:", e);
                voiceBtn.disabled = true;
                startConversationVoiceBtn.disabled = true;
                voiceBtn.innerHTML = '<i class="fas fa-microphone-slash"></i><span>خطا در راه‌اندازی</span>';
            }
        })();

        voiceBtn?.addEventListener("click", () => {
            toggleRecording(false);
        });

        startConversationVoiceBtn?.addEventListener("click", () => {
            toggleRecording(true);
        });

        function toggleRecording(isConversation) {
            if (!recognition) {
                alert("مرورگر شما از تشخیص گفتار پشتیبانی نمی‌کند.");
                return;
            }

            conversationActive = isConversation;
            const btn = isConversation ? startConversationVoiceBtn : voiceBtn;
            if (isRecording) {
                recognition.stop();
            } else {
                btn.disabled = true;
                btn.innerHTML = '<i class="fas fa-circle"></i><span>در حال ضبط...</span>';
                btn.classList.add("pulse-recording");
                recognition.start();
                isRecording = true;
            }
        }

        clearBtn?.addEventListener("click", () => {
            voiceText.value = '';
            autoGrow(voiceText);
            voiceText.focus();
        });

        // Conversation functionality
        toggleConversationBtn?.addEventListener("click", () => {
            // Switch to conversation tab
            tabButtons.forEach(btn => btn.classList.remove('active'));
            document.querySelector('[data-tab="conversation"]').classList.add('active');

            tabContents.forEach(content => {
                content.classList.add('hidden');
                if (content.id === 'conversation-tab') {
                    content.classList.remove('hidden');
                }
            });

            if (!conversationMode) {
                conversationMode = true;
                startConversation();
            }
        });

        async function startConversation() {
            try {
                addMessage('در حال اتصال به دستیار هوشمند...', 'ai', true);
                const res = await fetch("/conversation/start", { method: "POST" });
                const data = await res.json();
                removeTypingIndicator();
                currentQuestion = data.question;
                addMessage(data.question, 'ai');
                // Auto start listening for first answer
                setTimeout(() => toggleRecording(true), 1000);
            } catch (e) {
                console.error("Conversation start error:", e);
                removeTypingIndicator();
                addMessage("⚠️ خطا در برقراری ارتباط با سرور. لطفاً دوباره تلاش کنید.", 'ai');
            }
        }

        function addMessage(text, sender, isTyping = false) {
            const bubble = document.createElement('div');
            bubble.className = `conversation-bubble ${sender}-bubble`;

            if (isTyping) {
                bubble.innerHTML = `
                    <div class="font-semibold ${sender === 'ai' ? 'text-blue-300' : 'text-white'} mb-1">${sender === 'ai' ? 'I-SELECT' : 'شما'}</div>
                    <div class="typing-indicator">
                        <span></span>
                        <span></span>
                        <span></span>
                    </div>
                `;
            } else {
                bubble.innerHTML = `
                    <div class="font-semibold ${sender === 'ai' ? 'text-blue-300' : 'text-white'} mb-1">${sender === 'ai' ? 'I-SELECT' : 'شما'}</div>
                    <div>${text}</div>
                `;
            }

            conversation.appendChild(bubble);
            conversation.scrollTop = conversation.scrollHeight;
        }

        function removeTypingIndicator() {
            const typingIndicator = document.querySelector('.typing-indicator');
            if (typingIndicator) {
                typingIndicator.parentElement.parentElement.remove();
            }
        }

        async function processConversation(userMessage) {
            addMessage('', 'ai', true);

            try {
                const res = await fetch("/conversation/respond", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ message: userMessage })
                });
                const data = await res.json();
                removeTypingIndicator();

                if (data.question) {
                    addMessage(data.question, 'ai');
                    currentQuestion = data.question;
                }

                if (data.update_fields) {
                    updateFormFields(data.update_fields);
                    updateProgress();
                }

                if (data.completed) {
                    addMessage("✅ اطلاعات شما کامل شد! در حال تولید پیشنهادات شغلی و خلاصه پروفایل...", 'ai');
                    conversationActive = false;
                    setTimeout(generateAIInsights, 1500);
                } else {
                    // Continue listening for next answer
                    setTimeout(() => toggleRecording(true), 1000);
                }

            } catch (e) {
                console.error("Conversation error:", e);
                removeTypingIndicator();
                addMessage("⚠️ خطا در پردازش پاسخ. لطفاً دوباره امتحان کنید.", 'ai');
                conversationActive = false;
            }
        }

        // File upload handling
        fileUploadArea?.addEventListener('click', () => resumeFile.click());

        fileUploadArea?.addEventListener('dragover', (e) => {
            e.preventDefault();
            fileUploadArea.classList.add('dragover');
        });

        fileUploadArea?.addEventListener('dragleave', () => {
            fileUploadArea.classList.remove('dragover');
        });

        fileUploadArea?.addEventListener('drop', (e) => {
            e.preventDefault();
            fileUploadArea.classList.remove('dragover');
            const files = e.dataTransfer.files;
            if (files.length > 0) {
                handleFileUpload(files[0]);
            }
        });

        resumeFile?.addEventListener('change', (e) => {
            if (e.target.files.length > 0) {
                handleFileUpload(e.target.files[0]);
            }
        });

        async function handleFileUpload(file) {
            if (!file.type.includes('pdf') && !file.type.includes('word') && !file.type.includes('text') && !file.name.match(/\.(pdf|doc|docx|txt)$/i)) {
                alert('لطفاً فقط فایل‌های PDF، Word یا Text آپلود کنید.');
                return;
            }

            const formData = new FormData();
            formData.append('resume', file);

            uploadProgress.classList.remove('hidden');
            uploadProgressFill.style.width = '30%';
            uploadProgressPercent.textContent = '30%';

            try {
                const res = await fetch('/parse/resume', {
                    method: 'POST',
                    body: formData
                });

                uploadProgressFill.style.width = '80%';
                uploadProgressPercent.textContent = '80%';

                const data = await res.json();

                if (data.success) {
                    updateFormFields(data.fields);
                    updateProgress();
                    uploadProgressFill.style.width = '100%';
                    uploadProgressPercent.textContent = '100%';

                    setTimeout(() => {
                        uploadProgress.classList.add('hidden');
                        // Switch to voice tab to show the filled form
                        document.querySelector('[data-tab="voice"]').click();
                    }, 2000);
                } else {
                    throw new Error(data.error || 'خطا در پردازش فایل');
                }
            } catch (e) {
                console.error('File upload error:', e);
                alert('خطا در آپلود فایل: ' + e.message);
                uploadProgress.classList.add('hidden');
            }
        }

        // Form filling and AI features
        fillBtn?.addEventListener("click", async () => {
            const utter = (voiceText.value || "").trim();
            if (!utter) {
                alert("ابتدا صحبت کنید یا متنی بنویسید، سپس پردازش کنید.");
                return;
            }
            await fillFormFromText(utter);
        });

        async function fillFormFromText(text) {
            try {
                fillBtn.disabled = true;
                fillBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i><span>در حال پردازش...</span>';

                const res = await fetch("/nlp/parse", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ utterance: text })
                });

                if (!res.ok) throw new Error("NLP parse failed");
                const data = await res.json();

                updateFormFields(data);
                updateProgress();

                fillBtn.innerHTML = '<i class="fas fa-check"></i><span>فرم پر شد</span>';
                setTimeout(() => {
                    fillBtn.innerHTML = '<i class="fas fa-magic"></i><span>پردازش و پرکردن فرم</span>';
                    fillBtn.disabled = false;
                }, 2000);

                // Generate AI insights after form is filled
                setTimeout(generateAIInsights, 1000);
            } catch (e) {
                console.error(e);
                alert("خطا در پردازش متن. دوباره امتحان کنید.");
                fillBtn.innerHTML = '<i class="fas fa-magic"></i><span>پردازش و پرکردن فرم</span>';
                fillBtn.disabled = false;
            }
        }

        function updateFormFields(fields) {
            const setVal = (name, v) => {
                const el = document.querySelector(`[name="${name}"]`);
                if (el != null && v != null) {
                    el.value = v;
                }
            };
            setVal('first_name', fields.first_name || "");
            setVal('last_name', fields.last_name || "");
            setVal('age', fields.age || "");
            setVal('gender', fields.gender || "");
            setVal('experience_years', fields.experience_years || "");
            setVal('city', fields.city || "");
            setVal('military_status', fields.military_status || "");
            setVal('skills', fields.skills || "");
            setVal('interests', fields.interests || "");
        }

        // AI Insights functionality
        generateInsightsBtn?.addEventListener('click', generateAIInsights);
        manualInsightsBtn?.addEventListener('click', generateAIInsights);

        function generateAIInsights() {
            const formData = new FormData(document.getElementById('mainForm'));
            const data = Object.fromEntries(formData);

            // Only generate insights if form is sufficiently filled
            const filledFields = Object.values(data).filter(val => val && val.toString().trim() !== '').length;
            if (filledFields >= 4) {
                generateRecommendations();
                generateSummary();
                aiInsights.classList.remove('hidden');

                // Smooth scroll to insights
                setTimeout(() => {
                    aiInsights.scrollIntoView({ behavior: 'smooth', block: 'start' });
                }, 300);
            } else {
                alert('لطفاً حداقل ۴ فیلد از فرم را پر کنید تا بتوانیم تحلیل مناسبی ارائه دهیم.');
            }
        }

        async function generateRecommendations() {
            const formData = new FormData(document.getElementById('mainForm'));
            const data = Object.fromEntries(formData);

            try {
                jobSuggestions.innerHTML = '<div class="text-center py-4"><i class="fas fa-spinner fa-spin text-xl text-blue-400"></i><p class="mt-2">در حال تولید پیشنهادات شغلی...</p></div>';

                const res = await fetch('/ai/recommend-jobs', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });
                const result = await res.json();

                if (result.recommendations) {
                    jobSuggestions.innerHTML = result.recommendations.replace(/\n/g, '<br>');
                }
            } catch (e) {
                console.error('Job recommendations error:', e);
                jobSuggestions.innerHTML = '<div class="text-center py-4 text-red-300"><i class="fas fa-exclamation-triangle"></i><p class="mt-2">خطا در تولید پیشنهادات شغلی</p></div>';
            }
        }

        async function generateSummary() {
            const formData = new FormData(document.getElementById('mainForm'));
            const data = Object.fromEntries(formData);

            try {
                summaryText.innerHTML = '<div class="text-center py-4"><i class="fas fa-spinner fa-spin text-xl text-purple-400"></i><p class="mt-2">در حال تولید خلاصه پروفایل...</p></div>';

                const res = await fetch('/ai/generate-summary', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });
                const result = await res.json();

                if (result.summary) {
                    summaryText.textContent = result.summary;
                }
            } catch (e) {
                console.error('Summary generation error:', e);
                summaryText.innerHTML = '<div class="text-center py-4 text-red-300"><i class="fas fa-exclamation-triangle"></i><p class="mt-2">خطا در تولید خلاصه پروفایل</p></div>';
            }
        }

        // Clear all functionality
        clearAllBtn?.addEventListener('click', () => {
            if (confirm('آیا از پاک کردن تمام اطلاعات وارد شده اطمینان دارید؟')) {
                // Clear form fields
                document.querySelectorAll('.form-input').forEach(field => {
                    field.value = '';
                });

                // Clear voice text
                voiceText.value = '';
                autoGrow(voiceText);

                // Clear conversation
                conversation.innerHTML = '<div class="conversation-bubble ai-bubble"><div class="font-semibold text-blue-300 mb-1">I-SELECT</div><div>سلام! من دستیار هوشمند I-SELECT هستم. می‌تونم کمکتون کنم اطلاعاتتون رو به صورت مکالمه کامل کنیم. لطفاً میکروفون را روشن کنید تا شروع کنیم.</div></div>';

                // Hide AI insights
                aiInsights.classList.add('hidden');

                // Reset progress
                updateProgress();

                // Stop recording if active
                if (isRecording) {
                    recognition.stop();
                }

                conversationMode = false;
                conversationActive = false;
            }
        });

        // ==================== مصاحبه مهارتی ====================

        // مدیریت باز و بسته شدن مودال مصاحبه
        openInterviewBtn?.addEventListener('click', () => {
            const skillsInput = document.querySelector('input[name="skills"]');
            const userSkills = skillsInput.value.split(',').map(skill => skill.trim()).filter(skill => skill);

            if (userSkills.length === 0) {
                alert('لطفاً ابتدا مهارت‌های خود را در فرم وارد کنید.');
                return;
            }

            skills = userSkills;
            interviewModal.style.display = 'flex';
            initializeInterview();
        });

        closeInterviewBtn?.addEventListener('click', () => {
            if (interviewActive && !confirm('مصاحبه در حال انجام است. آیا مطمئن هستید که می‌خواهید خارج شوید؟')) {
                return;
            }
            interviewModal.style.display = 'none';
            stopInterview();
        });

        // Initialize مصاحبه
        async function initializeInterview() {
            // Reset state
            interviewActive = false;
            currentSkillIndex = 0;
            currentQuestionIndex = 0;
            warnings = {};
            interviewQuestions = {};
            interviewAnswers = {};

            // Initialize warnings for each skill
            skills.forEach(skill => {
                warnings[skill] = 0;
                interviewAnswers[skill] = [];
            });

            // Update UI
            updateSkillCards();
            updateWarnCounter();
            updateQCounter();
            updateProgressBar();

            // Initialize technologies
            await initializeAvatar();
            await initializeFaceMesh();
            initializeEventListeners();

            // Generate questions
            await generateInterviewQuestions();

            addInterviewMessage('مصاحبه مهارتی آماده است. برای شروع بر روی دکمه "شروع ضبط" کلیک کنید.', 'ai');
        }

        // Initialize آواتار سه‌بعدی با لیپ سینک
        async function initializeAvatar() {
            try {
                const scene = new THREE.Scene();
                const camera = new THREE.PerspectiveCamera(75, 1, 0.1, 1000);
                const renderer = new THREE.WebGLRenderer({
                    canvas: avatarCanvas,
                    alpha: true,
                    antialias: true
                });

                renderer.setSize(200, 200);
                renderer.setClearColor(0x000000, 0);

                // نورپردازی
                const ambientLight = new THREE.AmbientLight(0xffffff, 0.6);
                scene.add(ambientLight);

                const directionalLight = new THREE.DirectionalLight(0xffffff, 0.8);
                directionalLight.position.set(1, 1, 1);
                scene.add(directionalLight);

                // ایجاد یک هندسه ساده برای آواتار با قابلیت مورف
                const geometry = new THREE.SphereGeometry(1, 32, 32);
                const material = new THREE.MeshPhongMaterial({
                    color: 0x4f46e5,
                    transparent: true,
                    opacity: 0.8
                });
                const avatar = new THREE.Mesh(geometry, material);
                scene.add(avatar);

                // ایجاد مورف تارگت برای لب‌ها
                const mouthGeometry = new THREE.SphereGeometry(0.3, 16, 16);
                mouthGeometry.translate(0, -0.2, 0.9);
                const mouthMaterial = new THREE.MeshPhongMaterial({
                    color: 0xdc2626,
                    transparent: true,
                    opacity: 0.7
                });
                const mouth = new THREE.Mesh(mouthGeometry, mouthMaterial);
                avatar.add(mouth);

                camera.position.z = 3;

                // انیمیشن و لیپ سینک
                let mouthOpen = 0;
                let targetMouthOpen = 0;

                function animate() {
                    requestAnimationFrame(animate);

                    // لیپ سینک - حرکت لب‌ها بر اساس صحبت
                    mouthOpen += (targetMouthOpen - mouthOpen) * 0.2;
                    mouth.scale.y = 0.3 + mouthOpen * 0.5;
                    mouth.scale.x = 0.3 + mouthOpen * 0.2;

                    avatar.rotation.y += 0.01;
                    renderer.render(scene, camera);
                }
                animate();

                // تابع برای کنترل لیپ سینک
                function updateLipSync(isSpeaking) {
                    targetMouthOpen = isSpeaking ? 1 : 0;
                }

                avatarScene = { scene, camera, renderer, avatar, mouth, updateLipSync };
            } catch (error) {
                console.error('Error initializing avatar:', error);
            }
        }

        // Initialize تشخیص چهره با نقاط کمتر
        async function initializeFaceMesh() {
            try {
                // راه‌اندازی دوربین
                const stream = await navigator.mediaDevices.getUserMedia({
                    video: { width: 400, height: 300 }
                });
                userCam.srcObject = stream;

                // راه‌اندازی FaceMesh
                faceMesh = new FaceMesh({
                    locateFile: (file) => {
                        return `https://cdn.jsdelivr.net/npm/@mediapipe/face_mesh/${file}`;
                    }
                });

                faceMesh.setOptions({
                    maxNumFaces: 1,
                    refineLandmarks: false, // غیرفعال کردن نقاط اضافی
                    minDetectionConfidence: 0.5,
                    minTrackingConfidence: 0.5
                });

                faceMesh.onResults(onFaceResults);

                const camera = new Camera(userCam, {
                    onFrame: async () => {
                        await faceMesh.send({ image: userCam });
                    },
                    width: 400,
                    height: 300
                });
                camera.start();

            } catch (error) {
                console.error('Error initializing face mesh:', error);
                addAlert('خطا در راه‌اندازی دوربین. مصاحبه بدون نظارت بر چهره ادامه می‌یابد.', 'warning');
            }
        }

        // پردازش نتایج تشخیص چهره با نقاط کمتر
        function onFaceResults(results) {
            const canvasCtx = faceOverlay.getContext('2d');
            canvasCtx.save();
            canvasCtx.clearRect(0, 0, faceOverlay.width, faceOverlay.height);

            if (results.multiFaceLandmarks && results.multiFaceLandmarks.length > 0) {
                const landmarks = results.multiFaceLandmarks[0];

                // رسم فقط نقاط اصلی صورت
                drawConnectors(canvasCtx, landmarks, FACEMESH_TESSELATION,
                    { color: '#C0C0C030', lineWidth: 1 }); // کمرنگ‌تر

                // چشم‌ها با رنگ ملایم
                drawConnectors(canvasCtx, landmarks, FACEMESH_RIGHT_EYE,
                    { color: '#30E8BF50', lineWidth: 1 });
                drawConnectors(canvasCtx, landmarks, FACEMESH_LEFT_EYE,
                    { color: '#30E8BF50', lineWidth: 1 });

                // لب‌ها با رنگ ملایم‌تر
                drawConnectors(canvasCtx, landmarks, FACEMESH_LIPS,
                    { color: '#E30B5C50', lineWidth: 1 }); // قرمز کمرنگ

                // تحلیل جهت نگاه
                analyzeGaze(landmarks);
            } else {
                // چهره تشخیص داده نشد
                handleFaceLost();
            }

            canvasCtx.restore();
        }

        // تحلیل جهت نگاه
        function analyzeGaze(landmarks) {
            clearTimeout(faceLostTimer);
            clearTimeout(gazeAwayTimer);

            // فرض می‌کنیم اگر چهره تشخیص داده شده، کاربر به صفحه نگاه می‌کند
        }

        function handleFaceLost() {
            if (!faceLostTimer) {
                faceLostTimer = setTimeout(() => {
                    addWarning('gaze-away-8s');
                }, 8000);
            }
        }

        // Initialize event listeners برای مصاحبه
        function initializeEventListeners() {
            // رویدادهای صفحه‌کلید برای تشخیص تایپ حین پاسخ
            document.addEventListener('keydown', handleKeyDownDuringAnswer);
            document.addEventListener('keyup', handleKeyUpDuringAnswer);

            // رویدادهای تغییر تب/پنجره
            document.addEventListener('visibilitychange', handleVisibilityChange);
            window.addEventListener('blur', handleWindowBlur);

            // دکمه‌های کنترل مصاحبه
            intStart.addEventListener('click', startInterviewRecording);
            intStop.addEventListener('click', stopInterviewRecording);
            intFinish.addEventListener('click', finishInterview);
        }

        function handleKeyDownDuringAnswer(e) {
            if (interviewActive && isRecording) {
                addWarning('typing-during-answer');
            }
        }

        function handleKeyUpDuringAnswer(e) {
            // می‌توانید منطق بیشتری اینجا اضافه کنید
        }

        function handleVisibilityChange() {
            if (interviewActive && document.hidden) {
                addWarning('tab-switched');
            }
        }

        function handleWindowBlur() {
            if (interviewActive) {
                addWarning('tab-switched');
            }
        }

        // تولید سوالات مصاحبه
        async function generateInterviewQuestions() {
            try {
                // شبیه‌سازی تولید سوالات - در پیاده‌سازی واقعی با بک‌اند ارتباط برقرار می‌شود
                interviewQuestions = {};
                skills.forEach(skill => {
                    interviewQuestions[skill] = [
                        `لطفاً در مورد تجربه خود با ${skill} توضیح دهید.`,
                        `یک پروژه چالش‌برانگیز که با ${skill} انجام داده‌اید را شرح دهید.`,
                        `مهم‌ترین مفاهیم ${skill} از نظر شما کدام‌اند؟`
                    ];
                });

                addInterviewMessage(`سوالات مصاحبه برای ${skills.length} مهارت تولید شد.`, 'ai');
            } catch (error) {
                console.error('Error generating questions:', error);
                addInterviewMessage('خطا در تولید سوالات. لطفاً دوباره تلاش کنید.', 'ai');
            }
        }

        // شروع ضبط در مصاحبه
        function startInterviewRecording() {
            if (!interviewActive) {
                interviewActive = true;
                currentSkillIndex = 0;
                currentQuestionIndex = 0;
                askNextQuestion();
            }

            intStart.disabled = true;
            intStop.disabled = false;
            intStart.innerHTML = '<i class="fas fa-circle"></i><span>در حال ضبط...</span>';
            intStart.classList.add("pulse-recording");

            // شروع تشخیص گفتار
            if (recognition) {
                recognition.start();
                isRecording = true;

                // تایمر سکوت ۸ ثانیه‌ای
                clearTimeout(silenceTimer);
                silenceTimer = setTimeout(() => {
                    addWarning('silence-8s');
                    stopInterviewRecording();
                    askNextQuestion();
                }, 8000);
            }
        }

        // توقف ضبط در مصاحبه
        function stopInterviewRecording() {
            intStart.disabled = false;
            intStop.disabled = true;
            intStart.innerHTML = '<i class="fas fa-microphone"></i><span>شروع ضبط</span>';
            intStart.classList.remove("pulse-recording");

            if (recognition && isRecording) {
                recognition.stop();
                isRecording = false;
                clearTimeout(silenceTimer);
            }
        }

        // پرسش سوال بعدی
        function askNextQuestion() {
            if (currentSkillIndex >= skills.length) {
                finishInterview();
                return;
            }

            const currentSkill = skills[currentSkillIndex];
            const skillQuestions = interviewQuestions[currentSkill] || [];

            if (currentQuestionIndex >= skillQuestions.length) {
                // به سراغ مهارت بعدی برو
                currentSkillIndex++;
                currentQuestionIndex = 0;
                askNextQuestion();
                return;
            }

            const question = skillQuestions[currentQuestionIndex];

            // نمایش سوال در چت و استفاده از TTS
            speakQuestionWithStreaming(question);

            updateQCounter();
            updateProgressBar();
        }

        // استفاده از TTS برای خواندن سوال با استریم متن
        function speakQuestionWithStreaming(question) {
            // اول سوال را در چت نمایش می‌دهیم
            addInterviewMessage(question, 'ai');

            // سپس با TTS می‌خوانیم
            if ('speechSynthesis' in window) {
                // توقف TTS قبلی اگر وجود دارد
                if (currentTTS) {
                    speechSynthesis.cancel();
                }

                const utterance = new SpeechSynthesisUtterance(question);
                utterance.lang = 'fa-IR';
                utterance.rate = 0.8; // سرعت کمتر برای وضوح بیشتر
                utterance.pitch = 1;

                // فعال کردن لیپ سینک هنگام شروع صحبت
                utterance.onstart = function () {
                    if (avatarScene && avatarScene.updateLipSync) {
                        avatarScene.updateLipSync(true);
                    }
                };

                // غیرفعال کردن لیپ سینک هنگام پایان صحبت
                utterance.onend = function () {
                    if (avatarScene && avatarScene.updateLipSync) {
                        avatarScene.updateLipSync(false);
                    }
                    // فعال کردن ضبط برای پاسخ کاربر
                    setTimeout(() => {
                        intStart.disabled = false;
                        intStart.click(); // شروع خودکار ضبط پاسخ
                    }, 500);
                };

                speechSynthesis.speak(utterance);
                currentTTS = utterance;
            } else {
                // اگر TTS پشتیبانی نمی‌شود، مستقیماً ضبط را فعال کن
                setTimeout(() => {
                    intStart.disabled = false;
                    intStart.click();
                }, 1000);
            }
        }

        // به‌روزرسانی متن استریم کاربر
        function updateUserStreamingText() {
            // پیدا کردن آخرین حباب کاربر یا ایجاد جدید
            let userBubble = intChat.querySelector('.interview-user-bubble:last-child');
            if (!userBubble || !userBubble.classList.contains('streaming')) {
                userBubble = document.createElement('div');
                userBubble.className = 'interview-chat-bubble interview-user-bubble streaming';
                userBubble.innerHTML = `
                    <div class="font-semibold text-white mb-1">شما</div>
                    <div class="streaming-text"></div>
                `;
                intChat.appendChild(userBubble);
            }

            const streamingText = userBubble.querySelector('.streaming-text');
            streamingText.innerHTML = currentUserStreamingText + '<span class="streaming-cursor">|</span>';

            // اسکرول به پایین
            intChat.scrollTop = intChat.scrollHeight;
        }

        // اتمام مصاحبه
        async function finishInterview() {
            interviewActive = false;
            stopInterviewRecording();

            addInterviewMessage('مصاحبه به پایان رسید. در حال ارزیابی پاسخ‌ها...', 'ai');

            try {
                // شبیه‌سازی ارزیابی - در پیاده‌سازی واقعی با بک‌اند ارتباط برقرار می‌شود
                const results = {
                    per_skill: {},
                    overall: 75,
                    summary: 'کاربر دانش خوبی در مهارت‌های مطرح شده دارد و می‌تواند پروژه‌های مرتبط را مدیریت کند.'
                };

                skills.forEach(skill => {
                    results.per_skill[skill] = {
                        score: Math.floor(Math.random() * 30) + 70, // نمره تصادفی 70-100
                        evidence: 'پاسخ‌های کاربر نشان‌دهنده دانش عملی و تجربه کافی است.',
                        flags: warnings[skill] > 5 ? ['generic'] : []
                    };
                });

                displayInterviewResults(results);

            } catch (error) {
                console.error('Error scoring interview:', error);
                addInterviewMessage('خطا در ارزیابی مصاحبه. لطفاً دوباره تلاش کنید.', 'ai');
            }
        }

        // نمایش نتایج مصاحبه
        function displayInterviewResults(results) {
            // اعمال قاعده وارنینگ‌ها
            Object.keys(results.per_skill).forEach(skill => {
                if (warnings[skill] > 10) {
                    results.per_skill[skill].score = 0;
                    results.per_skill[skill].flags.push('invalidated');
                }
            });

            // نمایش نتایج در کارت‌ها
            updateSkillCardsWithResults(results.per_skill);

            // ذخیره در فیلدهای پنهان
            interviewOverall.value = results.overall;
            interviewSummary.value = results.summary;
            interviewPerskill.value = JSON.stringify(results.per_skill);
            interviewDone.value = "true";

            // فعال کردن دکمه ثبت نهایی
            updateSubmitButton();

            addInterviewMessage(`ارزیابی مصاحبه تکمیل شد. نمره کلی: ${results.overall}`, 'ai');
            intFinish.disabled = true;
        }

        // افزودن پیام به چت مصاحبه
        function addInterviewMessage(text, sender) {
            const bubble = document.createElement('div');
            bubble.className = `interview-chat-bubble interview-${sender === 'ai' ? 'ai' : 'user'}-bubble`;

            bubble.innerHTML = `
                <div class="font-semibold ${sender === 'ai' ? 'text-blue-300' : 'text-white'} mb-1">
                    ${sender === 'ai' ? 'دستیار مصاحبه' : 'شما'}
                </div>
                <div>${text}</div>
            `;

            intChat.appendChild(bubble);
            intChat.scrollTop = intChat.scrollHeight;
        }

        // افزودن هشدار
        function addWarning(type) {
            const skill = skills[currentSkillIndex];
            if (skill) {
                warnings[skill]++;
                updateWarnCounter();

                const warningMessages = {
                    'typing-during-answer': 'تایپ حین پاسخ‌دهی',
                    'silence-8s': 'سکوت طولانی مدت',
                    'tab-switched': 'تعویض تب/پنجره',
                    'gaze-away-8s': 'عدم توجه به صفحه',
                    'high-noise': 'نویز بالا',
                    'one-word': 'پاسخ تک‌کلمه‌ای'
                };

                addAlert(`هشدار: ${warningMessages[type] || type}`, 'warning');
            }
        }

        // افزودن اعلان
        function addAlert(message, type = 'info') {
            const alert = document.createElement('div');
            alert.className = `p-2 rounded text-sm ${type === 'warning' ? 'bg-yellow-500/20 text-yellow-300 border border-yellow-500/30' :
                type === 'error' ? 'bg-red-500/20 text-red-300 border border-red-500/30' :
                    'bg-blue-500/20 text-blue-300 border border-blue-500/30'
                }`;
            alert.textContent = message;

            intAlerts.appendChild(alert);

            // حذف خودکار پس از ۵ ثانیه
            setTimeout(() => {
                if (alert.parentNode) {
                    alert.parentNode.removeChild(alert);
                }
            }, 5000);
        }

        // به‌روزرسانی کارت‌های مهارت
        function updateSkillCards() {
            skillCards.innerHTML = '';

            skills.forEach(skill => {
                const card = document.createElement('div');
                card.className = 'skill-card';
                card.innerHTML = `
                    <div class="flex justify-between items-center mb-2">
                        <span class="font-semibold text-white">${skill}</span>
                        <span class="text-xs ${getStatusClass(warnings[skill])}">${getStatusText(warnings[skill])}</span>
                    </div>
                    <div class="progress-bar mb-2">
                        <div class="progress-fill" style="width: 0%"></div>
                    </div>
                    <div class="text-xs text-white/60">وارنینگ: ${warnings[skill]}/10</div>
                `;
                skillCards.appendChild(card);
            });
        }

        function updateSkillCardsWithResults(results) {
            skillCards.innerHTML = '';

            Object.keys(results).forEach(skill => {
                const result = results[skill];
                const isInvalidated = warnings[skill] > 10;
                const score = isInvalidated ? 0 : result.score;

                const card = document.createElement('div');
                card.className = `skill-card ${isInvalidated ? 'invalidated' : ''}`;
                card.innerHTML = `
                    <div class="flex justify-between items-center mb-2">
                        <span class="font-semibold text-white">${skill}</span>
                        <span class="text-xs ${getStatusClass(warnings[skill], true)}">
                            ${getStatusText(warnings[skill], true, result.flags)}
                        </span>
                    </div>
                    <div class="progress-bar mb-2">
                        <div class="progress-fill" style="width: ${score}%"></div>
                    </div>
                    <div class="flex justify-between text-xs mb-1">
                        <span class="text-white/60">نمره: ${score}</span>
                        <span class="text-white/60">وارنینگ: ${warnings[skill]}/10</span>
                    </div>
                    <div class="text-xs text-white/70">${result.evidence}</div>
                    ${result.flags.length > 0 ?
                        `<div class="text-xs text-yellow-400 mt-1">پرچم‌ها: ${result.flags.join(', ')}</div>` : ''
                    }
                `;
                skillCards.appendChild(card);
            });
        }

        function getStatusClass(warningCount, withResults = false) {
            if (withResults) {
                if (warningCount > 10) return 'status-invalid';
                if (warningCount > 5) return 'status-suspicious';
                return 'status-valid';
            } else {
                if (warningCount > 5) return 'status-suspicious';
                return 'status-valid';
            }
        }

        function getStatusText(warningCount, withResults = false, flags = []) {
            if (withResults) {
                if (warningCount > 10) return '🟥 نامعتبر';
                if (flags.includes('generic') || flags.includes('off-topic')) return '⚠️ مشکوک';
                return '✅ معتبر';
            } else {
                if (warningCount > 5) return '⚠️ مشکوک';
                return '✅ معتبر';
            }
        }

        function updateWarnCounter() {
            const totalWarnings = Object.values(warnings).reduce((sum, count) => sum + count, 0);
            warnCounter.textContent = totalWarnings;
        }

        function updateQCounter() {
            const totalQuestions = skills.reduce((sum, skill) =>
                sum + (interviewQuestions[skill]?.length || 0), 0);
            const answeredQuestions = skills.reduce((sum, skill, index) => {
                if (index < currentSkillIndex) {
                    return sum + (interviewQuestions[skill]?.length || 0);
                } else if (index === currentSkillIndex) {
                    return sum + currentQuestionIndex;
                }
                return sum;
            }, 0);

            qCounter.textContent = `${answeredQuestions}/${totalQuestions}`;
        }

        function updateProgressBar() {
            const totalQuestions = skills.reduce((sum, skill) =>
                sum + (interviewQuestions[skill]?.length || 0), 0);
            const answeredQuestions = skills.reduce((sum, skill, index) => {
                if (index < currentSkillIndex) {
                    return sum + (interviewQuestions[skill]?.length || 0);
                } else if (index === currentSkillIndex) {
                    return sum + currentQuestionIndex;
                }
                return sum;
            }, 0);

            const progress = totalQuestions > 0 ? (answeredQuestions / totalQuestions) * 100 : 0;
            intProgress.style.width = `${progress}%`;
        }

        function stopInterview() {
            interviewActive = false;
            stopInterviewRecording();

            // توقف TTS
            if (currentTTS) {
                speechSynthesis.cancel();
            }

            // توقف لیپ سینک
            if (avatarScene && avatarScene.updateLipSync) {
                avatarScene.updateLipSync(false);
            }

            // پاک‌سازی event listeners
            document.removeEventListener('keydown', handleKeyDownDuringAnswer);
            document.removeEventListener('keyup', handleKeyUpDuringAnswer);
            document.removeEventListener('visibilitychange', handleVisibilityChange);
            window.removeEventListener('blur', handleWindowBlur);

            // توقف دوربین
            if (userCam.srcObject) {
                userCam.srcObject.getTracks().forEach(track => track.stop());
            }
        }

        // Initialize the application
        document.addEventListener('DOMContentLoaded', function () {
            console.log('I-SELECT Enhanced Platform initialized successfully!');
        });
    </script>
</body>

</html>